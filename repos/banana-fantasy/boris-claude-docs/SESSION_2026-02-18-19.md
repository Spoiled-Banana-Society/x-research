# Session Notes — Feb 18-19, 2026

## A. Backend + Frontend + Cloud Integration (Feb 18-19)

### Vercel Deployment Setup
- App deployed at `banana-fantasy-sbs.vercel.app`
- Privy crashes on Vercel prerendering → fixed with error boundary around `PrivyProviderBase` + SSR skip (`mounted` state check)
- Guest user fallback added/reverted → fixed real issue: Privy App ID env var wasn't set on Vercel
- `force-dynamic` rendering added to fix prerender errors

### Staging System (`lib/staging.ts`)
- `?staging=true` activates staging mode (persists in sessionStorage)
- Runtime URL overrides via `?apiUrl=...` and `?wsUrl=...` params
- Originally used Cloudflare Quick Tunnels (ephemeral URLs) for local dev
- **Migrated to Cloud Run**: `https://sbs-drafts-api-staging-652484219017.us-central1.run.app`
- Production `.env.production` now points `NEXT_PUBLIC_DRAFTS_API_URL` to staging Cloud Run (all Vercel traffic goes to staging backend)

### API Layer Built (`lib/api/`)
- `client.ts` — Base HTTP client
- `config.ts` — API URL configuration
- `leagues.ts` — League/draft join APIs + `getBatchProgress()` + `stagingFillBots()`
- `owner.ts` — User profile CRUD
- `drafts.ts` — Draft state fetching
- `websocket.ts` — WebSocket client for real-time draft updates
- `firebase.ts` — Firebase Realtime DB integration

### Real API Wiring
- BatchProgressIndicator → wired to `GET /league/batchProgress` with 30s polling
- Drafting page → wired to real draft sync + API
- Draft room → WebSocket integration, draft state fetching without wallet auth
- BuyPassesModal → joins real leagues via `POST /league/{speed}/owner/{addr}`

### Draft Room Fixes (Feb 18)
- Full engine overhaul: WebSocket, UI components, pick card fixes
- Snake draft ordering for 150 pick slots
- Seat cards from draftOrder fallback
- Exit button positioning
- WS payload hardening to prevent mid-draft crashes
- Live filling progress on drafting page (4 iterations to get right)
- Draft state persistence across navigation with timestamp-based countdowns

### Nav/UI Polish
- Added Exposure + Marketplace to nav
- Minimal footer with copyright + links
- Profile dropdown: NFL team logo, wallet display
- Notification bell repositioned

---

## B. Coinbase Onramp Integration (Feb 19-20)

### Code Changes (DONE)
- `lib/contracts/bbb4.ts` — Added `getUsdcBalance(address)` utility
- `components/modals/BuyPassesModal.tsx`:
  - `fundWallet()` now uses `card: { preferredProvider: 'coinbase' }` (routes through Coinbase, not MoonPay)
  - USDC balance polling added (3s interval, 2min max) between funding and minting
  - New flow step: `waiting-for-usdc` between `funding` and `minting`
  - `onUserExited` callback added to `useFundWallet` for debugging
- `providers/PrivyProvider.tsx` — Added `fundingMethodConfig: { moonpay: { useSandbox: false } }`
- **TypeScript catch**: Privy type is `fundingMethodConfig` (singular), NOT `fundingMethodsConfig` (plural)

### Privy Dashboard Setup (NOT DONE — Boris manual step)
- URL: `https://dashboard.privy.io/apps/cmlg4vpxo01txl70dm0hr9t86/funding`
- Need to enable Coinbase Onramp → requires CDP API Key
- Get keys at: `https://portal.cdp.coinbase.com/`
- **Key ID**: UUID format
- **Private key**: Privy says "ECDSA PEM" — CDP may offer Ed25519 instead, try ECDSA first
- If dashboard won't save: try Configuration > Integrations tab, check key format includes PEM headers, ensure CDP project has Onramp enabled

---

## C. Current Architecture Summary

### Environment URLs
| Service | URL |
|---------|-----|
| Frontend (Vercel) | `banana-fantasy-sbs.vercel.app` |
| Drafts API (Cloud Run) | `sbs-drafts-api-staging-652484219017.us-central1.run.app` |
| WebSocket Server | `sbs-drafts-server-w5wydprnbq-uc.a.run.app` |
| Firebase | `sbs-prod-env-default-rtdb.firebaseio.com` |
| Privy Dashboard | `dashboard.privy.io/apps/cmlg4vpxo01txl70dm0hr9t86` |
| CDP Portal | `portal.cdp.coinbase.com` |

### Key IDs
- Privy App ID: `cmlg4vpxo01txl70dm0hr9t86`
- Firebase Project: `sbs-prod-env`
- BBB4 Contract: `0x14065412b3A431a660e6E576A14b104F1b3E463b`
- USDC on Base: `0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913`

---

## D. Open Items / Next Steps
1. **Coinbase Onramp dashboard config** — needs CDP API keys from Boris
2. **WebSocket server for staging** — still uses Cloudflare tunnel (ephemeral)
3. **End-to-end test** of card payment → USDC polling → mint flow
4. Production API cutover (currently all traffic goes to staging Cloud Run)
